const express = require('express');
const Config = require('../configs/main-config.json')["config"];
const sass = require('sass');
const jsdom = require('jsdom');
const log = require('./logging');
const { JSDOM } = jsdom;
const { promisify } = require('util');
const path = require('path');
const bodyParser = require('body-parser');
const fs = require('fs');
//const apicache  = require('apicache');
//const cache = apicache.middleware;

const verifyCookie = (db, cookie, cb) => {
	db.get("venus_cookie_" + cookie, (err, response) => {
		if (err) return cb(err, null);

		if (response != null) {
			cb(null, true);
		} else {
			cb(null, false);
		}
	});
};

module.exports = (web, db, bot, addonAPI, io, online) => {

	log('magenta', `* Web Interface is active on port ${Config["web interface port"]}`, io);

	web.use(express.static('src/static'));

	web.get('/', (req, res) => {
		let token = req.cookies["venus_auth_cookie"];

		if (!token) return res.redirect("/login");
		
		verifyCookie(db, token, (err, loggedIn) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}

			if (loggedIn && online) {
				res.redirect('/panel');
			}
			else {
				res.redirect('/login');
			}
		});
	});

	web.get('/:page', (req, res) => {
		JSDOM.fromFile(`src/pages/${req.params.page}.html`)
			.then((dom) => {

				sass.render({ file: './src/style.scss' }, function (err, result) {
					if (err) return err;

					let title = dom.window.document.createElement('title');
					title.innerHTML = 'Venus &mdash; ' + req.params.page.toUpperCase();

					let panelname = dom.window.document.querySelector('.panel-name');
					if (panelname !== null) {
						panelname.innerHTML = Config["web interface title"];
					}


					dom.window.document.head.appendChild(title);

					dom.window.document.getElementById('sass').innerHTML = result.css.toString();

					res.send(dom.window.document.querySelector('html').innerHTML);
				});
			}).catch(err => {
				let dontquestionit = `
(404) We couldn't find the page you were looking for, but we found a massive Wumpus
				
<pre style="font: 10px/5px monospace;">                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                 \`\`\`..,,::,,,,,,,,,,,,,,,,,,,,,,,,:;;,,.\`                                                              
                                                        \`.,::::::::::::::::;;;;;::;;;;;;;;;;;;;::::::::,,,,:;:,\`                                                       
                                                  \`,,::::::::;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::,,,:::\`                                                  
                                              ,::::::;;;;;;;;;;;;;;;;;;''''''''''''''''''''''';;;;;;;;;;;;;;;;;;::::,,::\`                                              
                                          .::::;;;;;;;;;;''''''''''+++++++''''';;::,,,,,::;;'''''+++''''''';;;;;;;;;;;::,,:,                                           
                                      \`,::::;;;;;;;'''''++++++++;;:.\`                                \`\`,:;'''''''';;;;;;;;::,:.                                        
                                    .:::;;;;;;''''+++++++':.\`                                                \`.:'+''''';;;;;;::,:\`                                     
                                  ,::;;;;;'''+++++++;.\`                                                            \`,'''''';;;;;:::,                                   
                                ::;;;;;''+++++++;\`                                                                      :+''';;;;;;::.                                 
                              ::;;;;''++++++',                                                                             .'+'';;;;;:;.                               
                            \`:;;;;'+++++++:                                                                                   :+'';;;;;:;                              
                           ,;;;;'++++++'\`                                                                                       .''';;;;:;,                            
                          :;;;'+++++++\`                                                                                           \`'';;;:;;;                           
                         :;;;'++++#+\`                                                                                               .'';;;;;;                          
                        :;;'+++++#'                                                                                                   '';;;;;;                         
                       :;;'++++##,                                                                                                     :';;;;;;                        
                      ,;;'++++##.                                  \`\`\`\`\`..............,......\`\`\`\`\`                                      ,';;;;;,                       
                      ;;;+++###,                    ..,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::::,\`                         :';;;;'                       
                     :;;'++###+           \`\`,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::;';,\`                  ';;;;;:                      
                     ;;;++####      \`.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::;';.               ';;;;'                      
                    \`;;'++####  \`.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::;+;.            ,;;;;'                      
                    ;;;+++###',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,...,,,,,,,,,,,,,,,,,,,,,,,,::::;+'.           ;;;;'.                     
                    ;;;+++#+;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::;+'          ';;;';                     
                    ;;;++++,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::::;++\`        :;;;''                     
                    ;;;'+',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::;++        ,;;;'+                     
                 ,,..,::;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::;;+'     ,,,,,,:;;                    
                ,,,,,,:;:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::::;;'+;   :,,.\`.,,;',                   
                ,,,,,:;::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::::::::;;;;++   :,,,,,,:;''                   
                ::,,,:;:::::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::::::::;;;;'+'  :,,,,:::;''                   
              ..:,,,,:;::::::::::::,,::,,:,:,,,,,::,::::::::,,,,,,,,:,:,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::::::::::::;;;;;++ \`::,,,:::;';                   
            ..........,::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::,,,::::,,:::,::::::::::::::::::::::::::::::;;;;;;;;+.;:,,,,:::;,,,,,:               
           ......\`\`\`\`.::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;'+..............,::              
          \`.........\`.:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;;:,...\`\`\`\`\`\`.\`\`..,:;              
          ...........,:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;;;:.,..\`\`\`\`\`\`\`\`\`\`..,:'              
          ...........::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;:;;;;;;;;;;;;;;:...\`\`\`\`\`\`\`\`\`\`\`\`.,;'              
         ...........,:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;;;;';,:..\`\`\`\`\`\`\`\`\`\`\`\`.,;'              
         ...........,:;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;;;''';.:........\`\`\`\`\`..,;;,,:\`          
         ...........,:;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;''''';.:...............,;,,,,::         
         ...........,;;;;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::;;;;;;;;;;;;;'''''',:..............,:;,,,,,:\`        
         ,..........:;;;;::::::::::::::::::::::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::::::::::::::::::::::::::::::;;;;;;;;;;;;;'''''+'::..............,::..,,,:;        
         ,.........,:;;;;:::::::::::::::::::,,,...................................,,,,,::::::::::::::::::::::::::;;;;;;;;;;;;;;''''++;,.............,,::..,,,:'        
         ,,,,......,:;;;;:::::::::::::::::,,............................................,,:::::::::::::::::::::::;;;;;;;;;;;;;'''''++;,............,,,:;:,,,::'        
         ,,,,,,,,,,,:;;;;::::::::::::::::,.....\`.\`........................................,,:::::::::::::::::::::;;;;;;;;;;;;;'''''++;,.........,,,,,,;;:,,::;'        
         ,,,,,,,,,,,:;;;;::::::::::::::,.....\`.\`\`\`........\`\`\`........\`\`\`.....................,::::::::::::::::::;;;;;;;;;;;;;'''''+++',......,,,,,,,,,;;:::::;'        
         ,,,,,,,,,,,:;;;;:::::::::::::....\`.\`\`\`\`\`\`\`\`..\`.\`.\`\`\`.......\`\`\`\`\`\`\`\`\`\`\`\`\`.\`...........,::::::::::::::::::;;;;;;;;;;;;'''''+++',,....,,,,,,,,,:;;:::::;'        
         ,,,,,,,,,,,:;;;;;;::::::::::.......\`\`\`............\`\`\`\`\`\`..\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`............,:::::::::::::::::;;;;;;;;;;;;'''''++#',,...,,,,,,,,,,:;;;:::;;'        
         ,,,,,,,,,,,:;;;;;;;;:::::::...................................\`\`\`\`....\`\`..\`..........,,:::::::::::::::::;;;;;;;;;;;;'''''+##;,,..,,,,,,,,,,,:;;;:::;''        
         ,,,,,,,,,,,:;;;;;:::::::::...........................................................,,,:::::::::::::::;;;;;;;;;;;;;'''''+##;,,,,,,,,,,,,,,,:;;;::;;''        
         :,,,,,,,,,,:;;;;;:::::::::...........................................................,,,::::::::::::::::;;;;;;;;;;;;'''''+##;,,,,,,,,,,,,,,,:;';::;;''        
         :,,,,,,,,,,:;;;;::':,::::...........................................................,,,,::::::::::::::;:;;;;;;;;;;;;'''''+##;,,,,,,,,,,,,,,,:;';;;;;'+        
         :,,,,,,,,,,:;;;;;###+::::..........................................................,,,,:::;;::::::::::::;;;;;;;;;;;;'''''+##;,,,,,,,,,,,,,,,:'';;;;;'+        
         :,,,,,,,,,,:;;;;###+,,'::..........................................................,,,,:::;;;:::::::::::;;;;;;;;;;;;'''''+##:,,,,,,,,,,,,,,,:'';;;;;''        
         :,,,,,,,,,,:;';####;:'+',.........................................................,,,,::::;;;;;;:::,,,,::;;;;;;;;;;;'''''+##:,,,,,,,,,,,,,,,:'';;;;'''        
         ,,,,,,,,,,,:;''####+++##,.........................................................,,,,::;;;;;;;::;#+++##;:;;;;;;;;;;'''''+#+:,,,,,,,,,,,,,,,;;';;;;'';        
         \`,,,,,,,,,,,;'##++######,,.......................................................,,,,:::;;;;;;::###':'+###:;;;;;;;;;'''''+#+:,,,,,,,,,,,,,,:;'';;;;'':        
          ,,,,,,,,,,,;'###+#++###,,.....,,,,,,,,,,..,.....................................,,,,::;;;';;;:###+;,'+####;;;;;;;;;'''''+#':,,,,,,,,,,,,,,:;'';;;;'+,        
          ,,,,,,,,,,,:;######+###,,..,,,,,,,,,,,,,,,,,,,,,,,.,,,...,,,,,,,,,,,,,,.......,,,,,,::;;'';;:#####+''+#####;;;;;;;;'''''+#;:,,,,,,,,,,,,,,:;'';;;;'+\`        
          ,,,,,,,,,,,:;##@@######,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,....,,,,,:::;''';;;##############';;;;;;;'''''+#;:,,,,,,,,,,,,,,:;';;;;;'+\`        
          :,,,,,,,,,,:;+#@@######,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::;;''';;####++++#######+;;;;;;''''''+#;,,,,,,,,,,,,,,,:;';;;;;''         
          ;,,,,,,,,,,:;;#@@@##@##,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,:::;;''';;#####+++##@@####;;;;;;'''''++#;,,,,,,,,,,,,,,,:;';;;;;''         
          :,,,,,,,,,,:';'#@######,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::;;'''';;##########@@@###;;;;;;'''''+++:,,,,,,,,,,,,,,,:;';;;;'';         
          \`,,,,,,,,,,:';;+#######,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::;;'''';;#########@@@@###;;;;;''''''+++;,,,,,,,,,,,,,,,:;';;;;'':         
           :,,,,,,,,,:;;;;'####+',,,,,,,,,,,:::::,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,::;;'''';;+#######@@@@@##+;;;;;''''''+++;,,,,,,,,,,,,,,,:'';;;;'+\`         
           :::::::::::;';;;;''';;:,,,,,,,::::::::::,,,,,,,,,,,,,,,,,,::::::::,,,,,,,,,,,,,,::;;''''';;'###@@###@@@###';;;;;''''''+++;,,,,,,,,,,,,,,,:'';;;;'+          
           :::::::::::;';;;;;;;;;:,,,,,,:::::::::::::,,,,,,,,,,,,,,::::::::::::,,,,,,,,,,,,::;;'''+';;;+#######@@###'';;;;;''''''++';,,,,,,,,,,,,,,,:''';;''+          
           \`::::::::::;';;;;;;;;;:,,,,,,::::::::::::::,,,,,,,,,,,,::::::::::::::,,,,,,,,,,,::;;'''+';;;'###########''';;;;'''''''++';:,,,,,,,,,,,,,,:'+'''''+          
            ::::::::::;';;;;;;;;;;,,,,,,::::::::::::::,,,,,,,,,,,::::::::::::::::,,,,,,,,,:::;;'''+';;;''+#######+''';;;;;'''''''++';:,,,,,,,,,,,,,,;'+''''+'          
            \`;;:::::::;';;;;;;;;;;:,,,,,:::::::::::::::,,,,,,,,,,:::::::::::::::::,,,,,,,,::;;''''+';;;;''''+++'''''';;;;;'''''''++;;:,,,,,,,,,,,,,:;'+''''+\`          
             ;;;;;;;;;;';;;;;;;;;::,,,,,:::::::::::::::,,,,,,,,,,:::::::::::::::::,,,,,,,:::;;'''++';;;;''''''''''''';;;;;''''''+++;;::::,,,,,,,,,,:;'+'''++           
              \`:;;;;;;;'';;;;;;;;;::,,,,,::;;;;;;;;::::,,,,,,,,,,:::::::::::::::::,,,,,,,::;;''''++';;;;''''''''';''';;;;'''''''+++;;:::::,,,,,,,,,:;'+''++:           
                   \`...,,;;;;;;;;:;:,,,,,::;;;;';;;;;::,,,,,,,,,,:::;;;;;;;;::::::,,,,,,,::;;''''++';;;;;'''''';''''';;;;'''''''+++;'::::::::,,,,,,:'++++++            
                        \`;;;;;;;;:;:,,,,,,::;;;;;;:::::,,,,,,,,,,::;;;;;''';;;;:::,,,,,,::;;;''''+'';;;;;''';'';;'''';;;;'''''''+++;':::::::::,,,,::'+.\`\`              
                         ;;;;;;;;;;;:,,,,..,::;;;;;;;;:,,,,,,,,,::;;;''';;;::::;::,,,,,,::;;''''++';;;;;;''';;';';''';;;;'''''''++#''::::::::::::::;'+                 
                         ;;;;;;;;;;;:,,,.....,::::::::,,,,,,,,,,:::;;''';;;;::::::,,,,,::;;;''''++'';;;;;;'''';''';';;;;'''''''+++#+';:::::::::::::;';                 
                         ;;;;;;;;;;;::,,........,,,,,.,,,,,,,,,,,,,:;;;;;;;;;::::..,,,,::;;''''+++'';;;;;;'';''''''';;;;'''''''+++##';;;;;::::::::;''\`                 
                         ;;;;;;;;;;;;::,,.............,,,,,,,,,,,,,,,,::::::::,,....,,::;;;''''++''';;;;;;;'''';'''';;;;'''''''+++##+;;;;;;;;;;;;;;'+                  
                         ;;;;;;;;;;;;;::,,............,,,,,,,,,,,,,,...............,,,::;;''''+++''';;;;;;;'''''''';;;;;''''''++++##'''';;;;;;;;;;'',                  
                         \`;;;;;;;;;;;;:::,,,..........,,,:::::,,,,,,..............,,,::;;;'''+#+'''';;;;;;;;;;'''';;;;;;''''''++++##  :'''''''''''+;                   
                          ';;;;;;;;;;;;:::,,,,,.....,,,,,:::::::,,,,..............,,,:;;;''''+#+'''';;;;;;;;;;''';;;;;;''''''+++++#;      #######                      
                          ';;;;;;;;;;;;;::::,,,,,,,,,,,,:::::::::,,,,,..........,,,,::;;'''++#+''''';;;;;;;;;;;;;;;;;;;''''''+++++#       ++++++#                      
                          \`';;;;;;;;;;;;;::::::,,,,,,,::::::::::::,,,,,,,.....,,,,,::;;;'''+#++''''';;;;;;;;;;;;;;;;;;;''''''++++#,       ++++++#                      
                           '';;;;;;;;;;;;;;::::::::::::::::::::::::,,,,,,,,,,,,,,:::;;;'''+##+'''''';;;;;;;;;;;;;;;;;;''''''++++++        +++++++                      
                           \`'';;;;;;;;;;';';;:::::::::::::::::::::::::,,,,,,,,,::::;;;'''+##+'''''';;;;;;;;;;;;;;;;;;;''''''+++++         +++++++                      
                            '''';;;;;;;;'''';;;;::::::::::::::::::::::::::::::::::;;;'''+##+''''''';;;;;;;;;;;;;;;;;;''''''+++++:         +++++++                      
                             '''''';;;;;'''''';;;;;;;;;:::::::::::::::::::::::::;;;;''++##+''''''''';;;;;;;;;;;;;;;;''''''++++++          ++++++,                      
                             \`''''''''''''''''''';;;;;;;;;;;;;;;;:::::::::::;;;;;;'''+##++'''''''''';;;;;;;;;;;;;;;'''''''+++++           :+++++                       
                              \`'''''''''''''''''''''''';;;;;;;;;;;;;;;;;;;;;;;;''''+###+'''''''''''';;;;;;;;;;;;;;'''''''+++++\`            +++#                        
                                '''''''''''''''''''''''''''''''''''''''';''''''++###++'''''''''''''';;;;;;;;;;;;''''''''+++++,             ++++                        
                                 ;'''''''''''''''''''''''''''''''''++++++++++++++++''''''''''''''''';;;;;;;;;;;''''''''+++++:              ';;                         
                                  \`''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''';;;;;;;;''''''''''+++++:               ;;;                         
                                    \`''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''';''''''''''''''+++++.                ;;;                         
                                       ;+''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''++++++                  ;;;                         
                                         \`:'++++''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''+++++'                   ;;;                         
                                              \`:++++++++++''''''''''''''''''''''''''''''''''''''''''''''''''''''++++++.                    ;;;                         
                                              ,+++++++++++++++++++++++'+'''''''''''''''''''''''''''''''''''''''+++++'                     ,;:,                         
                                             ;+++++++++++++++++++++++++++++++++++++''''''''''''''''''''''''++++++++                       ';;\`                         
                                            '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++####'                       ;:;                          
                                           '+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++############                       ;:;                          
                                         \`''''+++++++++'''''''''''+'+++++++++++++++#++++++++++#++##################\`                     :::.                          
                                        :'''+++++++++++'''''''''''''++++++++''+++++++++++++++++++++++++############+                     ;:;                           
                                       ;;;'++++++++++'''''''''''''''+++++++++..:++++++++++++++++++++++++############                    .:::                           
                                     \`:::::'+++++++++'''''''''''''''+++++++++,,..,'+++++++++++++++++++++############,                   :::                            
                                    .:::::'++++++++++'''''''''''''''+++####+';:,,...:++++++++++++++++++++############                  ,::;                            
                                   ,,,:::;++++++++++'''''''''''''''''+###+''''';::,,..,'++++++++++++++++++###########                  :,:                             
                                  :,,::::;+':,,,,,::;'''''''''''''''''''''''''''''::,,...:+++++''''+++++++++#########.                .\`.;                             
                                 :,,,:::::,,,,,.,,,,,,,,,,,::;'''+++++++'''''''''''';::,...,'++++''''++++++++########+               ,..:                              
                                :,,,,,::,.............,,,,,,,,,,,,,,::;'''+++++++''''';;:,,...:++'''';'+++++++########              ,..,.                              
                               :,,,,,,,......\`\`...................,.,,,,,,:'++++++++''''';::,,..,;';;::;++++++########             ,..,;                               
                              .:,,,,,,........\`\`.......................,,,,,:;++#+++++''''';;::,,...,:::;+++++########:           ,..,;                                
                              :,,,,,,.............,................\`\`.....,,,,:+####++++'++''';;::,,...,:;+++++#######+          ,..,;                                 
                             ,:,,,,,,.....,,,,,,,,.................\`\`\`\`.....,,,:'#+#+++++++'''''';;::,,....,;'++#######        \`...,;                                  
                             :::,,,,,,,,,,,,::::,.............................,::'++++++++++''''''++';;::,,,.....,:;'++.\`\`\`\`\`....,::                                   
                             :::,,,,::::,,,,,,.................,,,.............,:;+++++++'::,,,,,,,:;+++';;;::,,,,............,,:'\`                                    
                             ;::,,,,::,,,,,,,,,,,,,,,,,,,.......,,:,,,.........,,;;++++::,,,,,,,,,,:::;+#+''+''';;;::::::::::;''\`                                      
                             ;::::,,::,,,,,,,,,,,,,,,,,,,,,,,,....,:::,,,......,,;;'+;,,,,,,,,,,,,:::::;+#+'++++++++++++;::,\`                                          
                             ;::::::::::::::::::::,,,,,,,,,,,,,,,,..,::::,,,,,,,:;;;;,,,,,,,,,,,,::::::;;+#++++++++#+###                                               
                             ;;;::::::::;;;;;;;:::::::::::::,,,,,,,,,,,:::::,,,::;;;:,,,,,,,,,,,:::::::;;'++++++++++####                                               
                             ';;;;:;;;;;;'';;;;;;;;;;;::::::::::::,,,,,,,:::;;;;;;;;,,,,,,,,,,,:::::::;;;'++++++++++++##                                               
                             \`'';;;;''''''''''''''';;;;;;;;;;;;;;:::::,,,,,:;;;;'';;,,,,,,,,,,:::::::;;;''++#+++++++++##                                               
                              '''''''''''''''''''''''''''''';;;;;;;;;::::::::''''';::,,,,,,,::::::::;;;;'+++#+++++++++##                                               
                              \`+'''''''''''''''''''''''''''''''''''';;;;::::::;''';:::,,,,,:::::::;;;;;''+++#+++++++++##                                               
                               \`+++++'''''''''''''''''''''''''''''''''';;;;;;;;;'';::::,,,:::::::;;;;;''+++##+++++++++##                                               
                                 \`'++'''''''''''''''';;''''''''''''''''''''';;;;''';:::::::::::;;;;;;''+++##++++++++++##                                               
                                     ,''''''''''''''+++++++'+'''''''''''''''''''''';;::::::::;;;;;;'''+++####+++++++++##                                               
                                     '''''''''''''''++++++++++'''''''''''''''''''++';;;::::;;;;;;''''+++##++++++++++++##                                               
                                     '''''''''''''''+++++++++++''''''''''''''''+++++';;;;;;;;;;''''++++###++++++++++++##                                               
                                     '''''''''+''+++++++++++++++''''''''''''''+++++#+''';;;''''''+++++####+++++++++++###                                               
                                     '''''++++++++++++++++++++++++++'''''''''++++++#++''''''''++++++#####++++'+++++++###                                               
                                    :''''''++++++++#+++++++++++++++++''++'''+++++++##++'''+++++++++#####+++++''+++++++#'                                               
                                    ;'''''''+++++++++++++++++++++++++++++++++++++++####+++++++++######+++++++''+++++++#:                                               
                                    '''''''''+++;'+++++++++++++++++++++++++++++++++######++++++++##++++++'+++'''+++#+##\`                                               
                                   \`''''''''''+';+++++++++++++++++++++++++++++++++++#####+++++++++++++++''++''''+++####                                                
                                   ;'''''''''''+'+++++++++++++++++++++++++++++++++++####+++++++++++++++''''+''''++++###                                                
                                   ;''''''''''''++++++'++++++++++++++++++++++++++++####+++++++++++++++'''''''''''+++###                                                
                                  \`;'''''''''''''+++++++++++'+++++++'++++++++++++++#++++++++++++++++++''''''+''''+++###                                                
                                  ;''''''''''''''''''++++++++++++++++++++++++++++++++++++++++++++++++'''''''+''''+++##;                                                
                                  ;'''''''''''''''''''++++++++++++++++++++++++++++++++++++++++++++++''''''''++'''+++##                                                 
                                 .:''''''''''''''''''''++++++++++++++++++++++++++++++++++++'''+''+'''''''''''++''+++##                                                 
                                 ;:'''''''''''''''''''''+++++++++++++++++++++++++++++++++'''''''''''''''''''''++++++##                                                 
                                \`::'''+++''''''''''''+'''+++++++++++++++++++++++++++++++''''''''''''''''''''''++++++#;                                                 
                                :::'''+++++'''''''++++'+++++++++++++++++++++++++++++++'''''''''''''''''''''';'++++++#                                                  
                               ,:::;''++++++'''+++'++++++++++++++++++++++++++++++++++'''''''''''''''''''''';;;'+++++#                                                  
                              \`:::::'''++++++''+++++++++++++++++++++++++++++++++++++''''''''''''''''''''''';;;'++++++                                                  
                              :::::::'''+++++++++++++++++++++++++++++++++++++++++++++'''''''''''''''''''''';;;''+++#\`                                                  
                             :::::,:::''+++++++++++++++++++++++++++++++++++++++++++++'''''''''''''''''''''';;;''+++#                                                   
                            ::::,::::::;''+++++++++++++++++++++++++++++++++++++++++++''''''''''''''''''''';;;;''++++                                                   
                           :::::,::::::::''+++++++++++++++++++++++++++++++++++++'''''''''''''''''''''''';;:;;;''+++\`                                                   
                          :::::::::::::::;;+++#+++++++++++++++++++++++++++++++++''''''''''''''''''''''';;::;;;''++#                                                    
                         ::::,,::::::::::;;'++##++++++++++++++++++++++++++++++++++'''''''''''''''''''';;;::;;;''++'                                                    
                        :::::,,,::::::::;;;'++##+++++++++++++++++++++++++++++++++++'''''''''''''''''';;::::;;;'+++                                                     
                       ::,,,,,,::::::::;;;;'+####++++++++++++++++++++++++++++++++++++'''''''''''''';;;:::::;;;'+++                                                     
                      ,:,,,,,,,:::::::;;;;''+##################+++++++++++++++++++++++''''''''''';;;:::::::;;''++.                                                     
                     \`:,,,,,,,,,::::::;;;'''+######################++++++++++++++++++++'++''''';;:,,:::::::;;''++                                                      
                     :,,,,,,,,,,,::::;;;'''+###########################++++++++++++++++++''';;::,,,,::::::;;;'++'                                                      
                    ,::,,,,,,,,,:::::;;;'''+##########+';;;;'++##############+++++++++++';::,,,,,,,,::::::;;''++                                                       
                    ::::,,,,,,,,::::;;;'''++#####+.                 \`:'+##########+++++;::::,,,,,,,,::::::;;''++                                                       
                   \`::::::,,,,,:::::;;'''++#####\`                         .:+#######+++::::,,,,,,,,,:::::;;;'++\`                                                       
                   ;:::::::::::::::;;'''++####'                                .+#####;::::,,,,,,,,,:::::;;''++                                                        
                   ;;;::::::::::::;;;'''+####,                                     '#+::::,,,,,,,,,,:::::;;''+:                                                        
                   ;;;;;:::::::::;;;'''++###.                                        ;:::,,,,,,,,,::::::;;;'++                                                         
                   ';;;;;;;;;::;;;;;''++###,                                        ':::,,,,,,,,,,::::::;;''+'                                                         
                   :';;;;;;;;;;;;;;''++###:                                        .;::,,,,,,,,,,,::::::;;'++                                                          
                    '';;;;;;;;;;;'''+++##'                                         '::,,,,,,,,,,,,:::::;;;'++                                                          
                    '''''';;;;;;'''+++##'                                         \`;::,,,,,,,,,,,,:::::;;''+\`                                                          
                     +''''''''''''+++##'                                          ;::,,,,,,,,,,,,,::::;;;'++                                                           
                     .+++'''''''+++++#'                                           ;::,,,,,,,,,,,,,::::;;''+.                                                           
                      .+++++++++++++#:                                           ,;::,,,,,,,,,,,,,::::;;''+                                                            
                        '+++++++++##                                             ;;:::,,,,,,,,,,,::::;;;'+'                                                            
                          .'+++#+'\`                                              ;;:::::,,,,,,,,:::::;;''+                                                             
                                                                                 ;;:::::::::,,,:::::;;;'++                                                             
                                                                                 ;;;:::::::::::::::;;;''+,                                                             
                                                                                 ';;;;::::::::::::;;;''++                                                              
                                                                                 ';;;;;;;;:::::::;;;;''++                                                              
                                                                                 +'';;;;;;;;;;;;;;;;''++\`                                                              
                                                                                 :'''';;;;;;;;;;;;;'''++                                                               
                                                                                  +''''';;;;;;;;;'''+++\`                                                               
                                                                                  ;+'''''''''''''''++++                                                                
                                                                                   +++'''''''''''++++#                                                                 
                                                                                    ++++++''''++++++#                                                                  
                                                                                     ++++++++++++++#                                                                   
                                                                                      ;++++++++++#,                                                                    
                                                                                        ,++++++;                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
                                                                                                                                                                       
</pre>
				`
				res.send(dontquestionit);
			});
	});

	web.get("/api/login", bodyParser.urlencoded({ extended: true }), (req, res) => {
		let passwd = req.query.password;

		db.get("venus_auth_" + passwd, (err, response) => {
			if (err) {
				res.send("An error occurred. Please try again later");
				console.error(err);
				return;
			}

			if (response != null) {
				require('crypto').randomBytes(48, function (err, buffer) {
					let auth_cookie = buffer.toString('hex');

					db.set("venus_cookie_" + auth_cookie, response, (err, result) => {
						if (!err) {
							res.cookie("venus_auth_cookie", auth_cookie, { "httpOnly": true });
							res.redirect("/panel");
						} else {
							if (err) {
								console.error(err);
								res.redirect("/login#err=server");
							} else {
								res.redirect("/login#err=request");
							}
						}
					});

				});
			} else {
				res.redirect("/login");
			}
		});
	});

	/* BOT INFO */

	let startedAt = new Date;

	web.get('/bot-api/info', (req, res) => {
		let token = req.cookies["venus_auth_cookie"];

		if (!token) return res.json({
			"err": true,
			"errMsg": "No token cookie"
		});

		verifyCookie(db, token, (err, loggedIn) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}

			if (loggedIn && !online) {
				res.json({
					icon: '/images/default-profile.jpg',
					name: 'Unauthenticated',
					tag: 'Unauthenticated#0000',
					ping: '0',
					startedAt: 'offline',
					presence: 'offline'
				});
			}
			else if (loggedIn && online) {
				res.json({
					icon: bot.user.avatarURL,
					name: bot.user.username,
					tag: bot.user.tag,
					ping: bot.ping,
					startedAt: startedAt,
					presence: bot.user.presence
				});
			}
			else {
				res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			}
		});

	});

	web.get("/stats-api/commandUsage", (req, res) => {
		let cookie = req.cookies["venus_auth_cookie"];
		if (!cookie) res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			}
			db.keys("venus_stats_*", async (err, keys) => {
				if (err) return res.json({
					"err": true,
					"errMsg": "Server side db error"
				});

				if (!keys) return res.json({
					"err": true,
					"errMsg": "No keys on db (may be no stats)"
				});

				let stats = {};

				const get = promisify(db.get).bind(db);

				for (let key in keys) {
					try {
						let response = await get(keys[key]).catch(e => {
							console.error(e);
						});

						if (err) return console.err(err);

						stats[keys[key].replace("venus_stats_", "")] = JSON.parse(response);

					} catch (e) {
						stats[keys[key].replace("venus_stats_", "")] = { "err": true, "errMsg": "allan please add details" }
					}
				};

				res.json(stats);
			});

		});
	});

	web.get("/stats-api/getUptime", (req, res) => {
		let cookie = req.cookies["venus_auth_cookie"];
		if (typeof cookie == "undefined") return res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			}

			db.get("venus_uptime_data", (err, reply) => {
				if (err) {
					return res.json({
						"err": true,
						"errMsg": "Could not get data from db"
					});
				}

				try {
					let usageData = JSON.parse(reply);
					return res.json(usageData);
				} catch (e) {
					console.error(e);
					return res.json({
						"err": true,
						"errMsg": "Server side error"
					});
				}
			});

		});
	});

	web.get('/config-api/config/:config', (req, res) => {

		let cookie = req.cookies["venus_auth_cookie"];
		if (typeof cookie == "undefined") return res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			};
			res.sendFile(`${path.dirname(__dirname)}/configs/${req.params.config}.json`);
		});
	});
	
	web.get('/config-api/all', (req, res) => {
		let cookie = req.cookies["venus_auth_cookie"];
		if (typeof cookie == "undefined") return res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			};
			fs.readdir('./configs', (err, files) => {
				if(err) return res.send(err);

				res.json(files);
			});
		});
	});

	web.post('/config-api/configs/:config',bodyParser.json(), (req, res) => {
		res.send('ok');
		
		fs.writeFile(`./configs/${req.params.config}.json`, JSON.stringify(req.body, null, 4), (err) => {
			if(err) {
				console.log(err);
			} else {
				console.log('File saved');
			}
		});
	});
	
	web.get("/guild-api/invites", (req, res) => {
		let cookie = req.cookies["venus_auth_cookie"];
		if (typeof cookie == "undefined") return res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			};
			
			db.get("venus_guilds_invites", (err, reply) => {
				if (err) {
					return res.json({
						"err": true,
						"errMsg": "Could not get data from db"
					});
				}
				try{
					let invites = JSON.parse(reply);
					res.json(invites);
				} catch(err) {
					if(err) {
						res.json({
							"err" : true,
							"errMsg" : "Cannot parse json"
						});
						console.error(err);
					}
				}
			});
		});
	});

	web.get("/guild-api/guild/:id", (req, res) => {
		let cookie = req.cookies["venus_auth_cookie"];
		if (typeof cookie == "undefined") return res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			}
			
			if(!bot.guilds.get(req.params.id)) return;
			
			
			res.json({
				"name" : bot.guilds.get(req.params.id).name,
				"icon" : bot.guilds.get(req.params.id).iconURL
			});
		});
	});
	
	web.get("/guild-api/guilds", (req, res) => {
		let cookie = req.cookies["venus_auth_cookie"];
		if (typeof cookie == "undefined") return res.json({ "err": true, "errMsg": "Not authenticated" });

		verifyCookie(db, cookie, (err, authed) => {
			if (err) {
				return res.json({
					"err": true,
					"errMsg": "Could not get data from db"
				});
			}
			
			if (!authed) {
				return res.json({
					"err": true,
					"errMsg": "Not authenticated"
				});
			}
			
			res.json(bot.guilds.array());
		});
	});
	
	web.get("/api/signout", (req, res) => {
		res.clearCookie("venus_auth_cookie");
		res.redirect("/login");
	});
};